# 项目说明文档.md（更新：2026-02-08）

> 用途：记录当前策略实现进度、已解决问题、已确认的结构性漏洞，以及下一窗口的整体修正计划。
>
> 绝对基准：`02_策略逻辑文档0209改-3.md`（交易逻辑唯一来源）。

---

## 1. 当前基线

- **逻辑文档（基准）**：`02_策略逻辑文档0209改-3.md`
- **代码基线（最新）**：`实时test-02082006.py`（以及后续你现场运行/回测所用最新基准文件）
- **当前主攻模块**：卖出链路（阶段5）+ 与其强耦合的状态字段（`buy_pos/buy_days/rebuy_date`、PSL/PBL、半仓锁）。

---

## 2. 已完成进度（本轮窗口已落地/已对齐）

### 2.1 卖出链路关键对齐（阶段5）

- **整点铁律**：整点（10:00/10:30/11:00/11:30/13:30/14:00/14:30）只允许设线/清线，不允许同bar成交；14:55 另走兜底逻辑。
- **满仓 POS=1.0 的 14:55 兜底 First**：已按文档拆分并对齐（不操作 / 卖全 / 卖半），并保证 14:55 兜底优先于盘中 PSL 触线。
- **半仓 POS=0.5 的 14:55 兜底**：已补齐 `L1-A` 回补分支（与文档 First 对齐）。
- **半仓当日锁（POS 1→0.5 当日）三例外**：已按文档闭环并落地
  1) 14:55 命中 L1-A：允许回补（0.5→1.0）
  2) 整点命中 L1-C：仅授权；后续非整点触线允许卖剩余半仓（0.5→0）
  3) 14:55 命中 L1-F：允许卖剩余半仓（0.5→0）
- **PSL 与 PBL 可同时存在**：半仓整点逻辑中已去除“互相清除”行为（不再 set_psl 时清 pbl，不再 set_pbl 时清 psl）。

### 2.2 结构性防冲突策略（用户确认采用）

- **方案B硬闸**：14:55 之后（非 14:55 当分钟）禁止所有盘中触线成交，仅保留 14:55 兜底。
  - 该口径已由用户在文档末尾备注认可（“相撞先后无所谓/后续按现实现执行”）。

---

## 3. 本轮新增暴露的问题（已定位但尚未整体重构）

### 3.1 与 XH-233 相关链路存在“系统性逻辑漏洞”（下一窗口主攻）

> 你已确认：**凡是涉及 XH-233 的条件触发与状态维护，存在整体性漏洞，需要从链路角度重做对齐与鲁棒性**。

当前已知风险面（按“会改变策略行为”的优先级排序）：

1) **XH-233 的定义在不同 POS 阶段不同**
   - 文档：POS=1.0 时 XH-233=“买入时的前233日最高”；POS=0.5 时 XH-233=“卖出半仓时的前233日最高”（X-H 同理）。
   - 风险：代码若只维护一套 `buy_xh233/buy_xh233_date`，但没有严格区分“买入锚点”与“卖半锚点”，则会导致 L1-B/L0 子条件等大量分支误触发或漏触发。

2) **交易日间隔（T-0 - XH233-D）阈值与计算口径易错**
   - 本轮已定位到 L1-B 的“>2交易日”对应函数阈值（`gap>=3`）这一类映射问题；后续你计划将其改为 “>3交易日”。
   - 风险：代码内部 gap 的定义（是否包含当日/是否包含 XH233-D 当日）若与文档不一致，会导致“阈值改了但行为不对”。

3) **XH-233 日期来源与数据完整性**
   - 若 `buy_xh233_date` 在回测/实盘数据缺口、停牌、复权异常时为 None 或偏移，会让 gap 逻辑进入不可控分支。

4) **半仓整点 L0 子条件组（A/B/C）强依赖 XH-233 / X-H / gap**
   - 任一锚点维护错，会把 PBL 线设置到错误位置，进一步影响回补与卖出链路。

### 3.2 运行时错误：缺失 `PoolManager.record_sell_1455_log`

- 已在回测日志中出现：`PoolManager` 无 `record_sell_1455_log` 方法导致卖出检测异常中断。
- 该方法本质是“日志留痕/可观测性”，不应影响交易决策，但缺失会直接导致策略崩溃。

---

## 4. 下一窗口整体修正计划（围绕 XH-233 链路重构对齐）

### 4.1 总体目标

- 将 **XH-233/X-H 的状态维护、日期维护、gap 计算、条件触发** 做成一条“可验证、可回溯、可复用”的闭环。
- 任何引用 XH-233 的条件（L1-B、半仓 L0 子条件组等）统一走同一套口径函数，杜绝“不同分支各算各的”。

### 4.2 建议的实施顺序（小步迭代）

**Step 1：把 XH-233 相关状态显式拆分成两套锚点（强建议）**
- `xh233_buy_anchor`：买入时刻（POS=1.0 进入买入仓的锚点）
- `xh233_sellhalf_anchor`：卖半时刻（POS=1.0→0.5 的锚点）
- 同理：`x_h_buy_anchor`、`x_h_sellhalf_anchor`
- 每套都要有：`value`、`date`、`source`（来源说明：买入/卖半/回补等）

**Step 2：统一交易日间隔函数（gapTD）并明确口径**
- 输出：`gap_td`（整数）+ `is_valid`（是否可用）
- 明确：“T-0 - XH233-D > N 个交易日”在代码中对应 `gap_td >= N+1` 的映射。
- 对 L1-B 的阈值修改（>2→>3）只改这里的阈值映射，不在各分支散落修改。

**Step 3：统一 L1-B 判定函数（只做判定，不做副作用）**
- 输入：`R-H`、`XH233`、`X-H`、`gap_td`
- 输出：True/False + 命中原因（便于日志）

**Step 4：半仓 L0 子条件组复核与重构**
- 将 A/B/C 子条件改为调用统一的锚点与 gap 函数，避免重复遍历交易日。
- 同时补充“锚点缺失时的安全退化策略”（直接不命中/打印告警）。

**Step 5：补齐可观测性与防崩溃**
- 为 `PoolManager.record_sell_1455_log` 增加一个“只记录不改状态”的最小实现（或删除调用点，但不建议）。
- 为所有 XH-233 相关关键判断增加统一日志标签，回测时可定位“误触发/漏触发”的根因。

### 4.3 验收标准（下一窗口的完成判定）

- 任意涉及 XH-233 的规则（L1-B、半仓 L0 子条件组、相关 14:55/整点分支）在日志中能打印：
  - 使用的是“哪套锚点”（buy_anchor / sellhalf_anchor）
  - 该锚点的 value/date
  - gap_td 数值
  - 命中/不命中原因
- 修改“>2交易日→>3交易日”只需修改**一个阈值点**，回测结果表现符合预期。

---

## 5. 交接备注（下个窗口从哪里继续）

- 下个窗口直接从 **Step 1（双锚点拆分）+ Step 2（统一gapTD函数）** 开始。
- 在开始重构前，先把 **`PoolManager.record_sell_1455_log` 缺失**补齐，避免回测过程中断影响验证。

---

## 6. 本阶段关键文件清单

- 逻辑文档：`02_策略逻辑文档0209改-3.md`
- 项目说明（本文件）：`项目说明文档.md`
- 最新代码：`实时test-02082006.py`（以及你实际运行/回测的最新基准版本）

