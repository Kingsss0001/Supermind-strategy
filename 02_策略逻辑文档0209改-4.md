# SuperMind量化策略核心逻辑文档

**版本**: 2.2.1  
**更新日期**: 2026-02-05  
**说明**: 本文档使用符号化语言描述策略逻辑，所有符号在开头统一定义

---

## 📐 第一部分：符号定义表

### 时间相关符号
```
T-0        = 当前运行日
T-1        = 前一交易日
T-n        = 往前推n个交易日
所有T-n-X都是动态数据，代表交易日前一天的数据
```

### 价格相关符号（历史数据/盘后计算）
```
T-1-H        = 昨日最高价
T-1-C        = 昨日收盘价
T-0-H      = 今日最高价（盘后）
T-0-L      = 今日最低价（盘后）
T-0-C      = 今日收盘价（盘后）
H-233      = 过去233日最高价（不含T-0）,每天盘后把T-0-H和H-233做比较，IF H-233 < T-0-H → H-233 = T-0-H
H-233-D    = 创过去233日最高价那一天的日期，每天盘后把T-0-H和H-233做比较，IF H-233 < T-0-H → H-233-D = T-0
H-ALL      = 历史所有最高价
GAP-TD(T-0, H-233-D) = T-0 与 H-233-D 之间相隔的交易日数量（不含 H-233-D 当日，含 T-0 当日）
```

### 价格相关符号（实时数据/盘中计算）
```
R-P        = 当前实时价格
R-H        = 今日运行最高价（从9:30到当前）
R-L        = 今日运行最低价（从9:30到当前）
R-O        = 今日开盘价
R-C        = 今日收盘价
```

### 区间价格符号
```
I-L[t1,t2] = 时间区间[t1,t2]内的最低价
I-H[t1,t2] = 时间区间[t1,t2]内的最高价

示例：
I-L[10:00,10:30] = 10:00到10:30的区间最低价
区间定义：每个整点和半点往前推30分钟
```

### 均线相关符号
```
MA-n       = n日均线（盘后，用收盘价）
R-MA-n     = n日实时均线（盘中，含当前价）

常用：
MA-10, R-MA-10     = 10日均线
MA-5, R-MA-5       = 5日均线
MA-233             = 233日均线
```

### 技术指标符号
```
T-0-DIF        = MACD的DIF值（盘后）
R-DIF      = 实时DIF值（盘中）
T-1-DIF    = 昨日DIF（盘后）
T-0-MACD       = MACD柱状值（盘后）
R-MACD     = 实时MACD值（盘中）
T-1-MACD   = 昨日MACD（盘后）
```

### 成交量相关符号
```
VOL-MA-n   = n日平均成交量
VOL-MAX-n  = 近n日最大成交量

常用：
VOL-MA-21, VOL-MA-233    = 21日、233日平均量
VOL-MAX-5, VOL-MAX-55    = 近5日、近55日最大量
```

### 仓位和持仓符号
```
POS        = 持仓比例（1.0=满仓，0.5=半仓，0=空仓）
DAYS       = 持仓天数（买入当天=1）
B-P        = 股票买入价格
REBUY-DATE = 回补日期（用于T+1限制判断）
```

### 追踪变量符号
```
DC         = 下降次数（decline count）
             规则：T-0-H < T-1-H AND DIF < T-1-DIF → DC+1

T-1-H     = 前一日最高价（盘后）
T-1-DIF   = 前一日DIF值（盘后）
```

### 预埋线符号
```
PSL        = 预卖线价格（pre-sell line）
PSL-T      = 预卖线类型（'full'=全仓，'half'=半仓, 'empty'=从半仓状态清空）
PBL        = 预买线价格（pre-buy line，用于从准备仓进入买入仓的全仓买入）
PBL-T      = 预买线价格（'full'=全仓买入，'half'=半仓买入或回补半仓）
```

### 关键节点符号
```
整点列表  = ['10:00', '10:30', '11:00', '11:30', '13:30', '14:00', '14:30']
兜底时刻  = '14:55'
TRG-TIME  = 触发时刻记录
```

### 逻辑运算符
```
>、>=、<、<=、=    = 比较运算
AND               = 且（同时满足）
OR                = 或（任一满足）
→                 = 则执行
```

---

## 🌳 第二部分：策略完整流程图

```
┌─────────────────────────────────────────┐
│         每日盘后选股                      │
│  T-0-H>=H-233 + 均线 + 成交量 + 历史涨幅   │
└───────────────┬─────────────────────────┘
                ↓
         【进入预备仓】
         DC=0（创新高时重置）
                ↓
         ┌──────┴──────┐
         │  预备仓检测   │
         │  MA10回撤    │
         └──────┬──────┘
                ↓
         【转入准备仓】
         DC继承
                ↓
    ┌───────────┼───────────┐
    ↓           ↓           ↓
【买入检测】 【出仓检测】 【每日更新】
DIF突发+10分钟  DC>2出局   DC累加
+买入线触发
    │           │           │
    └───────────┴───────────┘
                ↓
    ┌───────────┴───────────┐
    │    买入前判断涨幅       │
    │ 涨幅>=10%→回预备仓     │
    │ 触线<H-233→全仓买入    │
    │ 触线>=H-233→半仓买入   │
    └───────────┬───────────┘
                ↓
         【进入买入仓】
         POS=1.0或0.5
         DAYS=1, DC继承
                ↓
    ┌───────────┴───────────┐
    │      买入仓卖出        │
    │   T+1规则（DAYS>=2）   │
    └───────────┬───────────┘
                ↓
    ┌───────────┼───────────┐
    ↓                       ↓
【POS=1.0】              【POS=0.5】
满仓卖出检测              半仓操作检测
    ↓                       ↓
整点：检测触发条件       整点：检测触发条件
↓                       ↓
设PSL或清空             设PSL/PBL或清空
↓                       ↓
实时：价格触线卖出       实时：触线卖出或回补
↓                       ↓
14:55：兜底逻辑         14:55：兜底逻辑
    │                       │
    └───────────┬───────────┘
                ↓
         【卖出完成】
         POS=0
                ↓
    ┌───────────┴───────────┐
    │     根据DC和MA10       │
    │  决定去预备仓/准备仓    │
    │     或彻底离场          │
    └───────────────────────┘
```

---

## 📋 第三部分：各阶段详细逻辑

## 阶段1：选股入预备仓

### 执行时机
```
after_trading - 每日收盘后执行一次
```

### 选股条件A组（数据充足：≥233日）

```
A1: T-0-H >= H-233              (创233日新高，含等于)
A2: T-0-H > MA-233              (突破233日均线)
A3: VOL-MA-21 >= VOL-MA-233×0.99 OR VOL-MAX-6 >= VOL-MAX-55 (成交量)
A4: 代码300/301开头 AND 不含ST  (创业板非ST)
A5: 过去89日出现过 >=10% 的涨幅  (历史涨幅)

IF (A1 AND A2 AND A3 AND A4 AND A5):
    → 进入预备仓
```

### 选股条件B组（数据不足：55-232日）

```
B1: T-0-H > H-ALL               (创历史新高)
B2: 同A4                        (创业板非ST)
B3: 同A5                        (历史涨幅)

IF (B1 AND B2 AND B3):
    → 进入预备仓
```

### 选股条件C组（数据太少：<55日）

```
直接排除，不纳入筛选
```

### 初始化变量
```
进入预备仓时：
    DC = 0                      (再次创233日新高时DC重置归零)
    T-1-H = T-0-H
    T-1-DIF = T-0-DIF
    entry_date = T-0
```

---

## 阶段2：预备仓→准备仓

### 执行时机
```
handle_bar - 盘中每分钟执行
```

### 触发条件
```
R-L <= R-MA-10 × n  
n = 1.005

说明：
- R-L: 今日从开盘到当前的最低价
- R-MA-10: 实时10日均线
- n: 容错系数
```

### 执行动作
```
IF (触发条件满足):
    → 从预备仓移除
    → 加入准备仓
    → 记录触发时间、价格
    → DC继承（保持原值不变）
```

---

## 阶段3：准备仓出仓检查

### 执行时机
```
after_trading - 每日收盘后执行
```

### 步骤1: 更新DC

```
IF (T-0-H < T-1-H AND DIF < T-1-DIF):
    DC = DC + 1                 (最高价和DIF都下降，完全疲软)

更新前值：
    T-1-H = T-0-H
    T-1-DIF = DIF
```

### 步骤2: 判断是否出仓

```
IF (DC <= 2) OR (DC = 3 AND 从股票进入准备仓前5日到DC=3的当日之间，有任何一天的成交量创过去55个交易日新高):
    → 继续持有

ELSE:
    → 彻底出局
    → 清除所有追踪数据
```

---

## 阶段4：准备仓→买入仓

### 执行时机
```
handle_bar - 盘中每分钟执行
```

### 步骤1: DIF突发检测

```
IF (R-DIF >= T-1-DIF):
    → 记录 TRG-TIME = 当前时刻
    → 继续等待（不立即买入）
```

### 步骤2: 10分钟后设置买入线

```
elapsed = 当前时刻 - TRG-TIME

IF (elapsed >= 10分钟 AND 买入线未设置):
    买入线 = R-H × 1.004
    → 记录买入线
```

### 步骤3: 判断买入条件

```
涨幅检查：
IF ((PBL - T-1-C) / T-1-C >= 10%):
    → 涨幅过大，不买入
    → 转回预备仓
    → 清除TRG-TIME、买入线
    → DC处理：
       IF (当前股价未创233日新高):
           → DC继承（保持原值）
       ELSE IF (当前股价已创233日新高):
           → DC重置为0
	→ 该股票在当日将不再触发任何操作

买入判断：
ELSE IF (R-P >= 买入线):
    
    IF (PBL < H-233*0.97):
        → 触发全仓买入
		→ PBL-T = 'full'
        → POS = 1.0
    
    ELSE IF (PBL >= H-233*0.97):
        → 触发半仓买入
		→ PBL-T = 'half'
        → POS = 0.5
		→ 14:55分时依然未触发买入，该股票在盘后重新转入预备仓, 且该股票在当日将不再触发任何操作
```

### 买入后初始化

```
买入成功后：
    → 从准备仓移除
    → 加入买入仓
    → POS = 1.0 或 0.5（根据上述条件）
    → DAYS = 1
    → 记录买入价格 B-P、买入时间
    → 记录 XH-233（这里代表买入时的H-233）
    → 记录 X-H（这里代表买入当天盘后最高价）
    → 记录 T-1-H（昨日最高）
    → 记录 T-1-DIF（昨日DIF）
    → DC继承
    → 清除 TRG-TIME、买入线
```

---

## 阶段5：买入仓卖出逻辑

### 核心框架

**统一检测流程**：
```
1. 每个整点获取：[DAYS, R-O, R-H, R-L, R-P, R-DIF, R-MACD, R-MA-10, R-MA-5]
2. 按优先级检测触发条件（1级>2级）
3. 根据触发结果设置/清空PSL或PBL
4. 实时检测价格触线
5. 14:55执行兜底逻辑
```

**整点列表**：
```
['10:00', '10:30', '11:00', '11:30', '13:30', '14:00', '14:30']
```

**区间定义**：
```
每个整点和半点往前推30分钟
例如：10:00的区间 = [09:30, 10:00]
     10:30的区间 = [10:00, 10:30]
```

---

### T+1规则前置检查

```
IF (DAYS < 2):
    → 不进行任何卖出检测
    → 直接返回
```

---

### PSL/PBL通用计算规则

```
区间最低价 L = I-L[前30分钟]
区间最高价 H = I-H[前30分钟]

基础公式：
    PSL = L × 0.996
    PBL = H × 1.004

智能修正（PSL）：
    IF (R-MA-10 <= L <= R-MA-10 × 1.01):
        PSL = R-MA-10 × 0.996
    
    IF (R-MA-5 <= L <= R-MA-5 × 1.01):
        PSL = R-MA-5 × 0.996
```

---

### 整点检测核心规则

**PSL/PSL-T更新规则**：
```
PSL：只涨不跌（max(旧,新)）
PSL-T：每次刷新（根据当前触发条件）

触发L1-C或2-B → PSL=max(旧,新), PSL-T='full'
触发L1-A或L1-B或2-2或L2-A → PSL=max(旧,新), PSL-T='half'
触发L1-D或L2-1或L2-3 → PSL=None, PSL-T=None（好信号清空）
无触发 → PSL=None, PSL-T=None
```

**PBL更新规则**：
```
触发H2-2 → PBL=min(旧,新)（只跌不涨）
其他情况 → PBL=None
```

**检测优先级**：
```
1级触发 → 执行行为，停止检测
无1级触发 → 检测2级 → 执行行为
```

---

### 触发条件（POS=1.0）

#### L1-A: 高开突破
```
条件：R-O > T-1-H
```

#### L1-B: 买入后创新高
```
条件：R-H >= XH-233 × 0.999 AND XH-233 × 0.999 > X-H AND (T-0 - H-233-D >3个交易日)  
```

#### L1-C: 盘中疲软
```
条件：L < R-MA-10 AND R-DIF < T-1-DIF
```

#### L1-D: 回调反弹
```
条件：R-L < R-MA-10 AND R-DIF >= T-1-DIF
```

#### L1-E: 尾盘疲软（该条只对尾盘有效）
```
条件：R-H >= T-1-H AND R-P < R-O
```

#### L1-F: 尾盘下10均（该条只对尾盘有效）
```
条件：R-P < R-MA10
```

#### L2-1: 强势上涨
```
条件：R-H >= T-1-H AND R-DIF >= T-1-DIF
```

#### L2-2: 高位滞涨
```
条件：R-H >= T-1-H AND R-DIF < T-1-DIF
```

#### L2-3: 低位企稳
```
条件：R-H < T-1-H AND R-MACD >= T-1-MACD
```

#### L2-4A: 第2天疲软
```
条件：DAYS=2 AND R-H < T-1-H AND R-MACD < T-1-MACD
```

#### L2-4B: 第3+天疲软
```
条件：DAYS>2 AND R-H < T-1-H AND R-MACD < T-1-MACD
```

#### L0: 半仓回补
```
条件（POS=0.5）：R-MACD >= T-1-MACD
```
---

### 满仓整点行为总结（POS = 1.0）

```
系统优先级：1级系统 > 2级系统
说明：先检测1级，1级触发则执行1级行为；1级未触发才检测2级

整点流程：
检测点：整点设置 PSL（POS=1.0）
命中策略：First（自上而下，命中即停止）
1. L1-B → 设置PSL, PSL-T='half', PSL=max(旧,新) → RETURN
2. L1-D → 清空PSL, PSL-T=None → RETURN
3. L1-C → 设置PSL, PSL-T='full', PSL=max(旧,新) → RETURN
4. L1-A → 设置PSL, PSL-T='half', PSL=max(旧,新) → RETURN
5. L2-4B → 设置PSL, PSL-T='full', PSL=max(旧,新) → RETURN
6. L2-2 OR L2-4A → 设置PSL, PSL-T='half', PSL=max(旧,新) → RETURN
7. L2-1 OR L2-3 → 清空PSL, PSL-T=None → RETURN

设置PSL后不检测触线，直接返回
```

### 满仓14:55兜底逻辑总结（POS = 1.0）

```
14:55时刻强制执行逻辑（无论是否设置PSL）：

检测点：14:55兜底操作（POS=1.0）
命中策略：First（自上而下，命中即停止）
1. L1-D OR L2-1 OR (L1-A WHEN R-P >= R-O) OR (L1-B WHEN R-P >= R-O) → 不执行任何操作 → RETURN
2. (L2-4B WHEN T-0 != REBUY-DATE) OR (L1-F WHEN T-0 != REBUY-DATE) → 卖出全仓 → POS: 1.0 → 0 → RETURN
3. ELSE → 卖出半仓 → POS: 1.0 → 0.5 → RETURN

### 满仓实时检测（非整点）

```
IF (PSL已设置):
    IF (R-P <= PSL):
        
        回补T+1限制检查：
        IF (T-0 = REBUY-DATE):
            → 最多卖0.5（原有半仓）
            → POS: 1.0 → 0.5
        ELSE:
            IF (PSL-T = 'full'):
                → 卖全仓，POS: 1.0 → 0
            ELSE IF (PSL-T = 'half'):
                → 卖半仓，POS: 1.0 → 0.5
```
```
半仓卖出成功后：
    → POS = 0.5
    → 记录 XH-233（卖出时的H-233）
    → 记录 X-H（卖出当天盘后最高价）
    → 记录 T-1-H（昨日最高）
    → 记录 T-1-DIF（昨日DIF）
    → DC继承
	
	
```
### 半仓整点行为总结（POS = 0.5）

```
检测点：整点设置 PSL/PBL
命中策略：First（自上而下，命中即停止）
1. (L0 WHEN (T-0 - H233-D <=3个交易日)) OR ((L0 WHEN (T-0 - H233-D >3个交易日)) AND (R-H < H-233 × 0.97)) → 设置PBL, PBL-T='half', PBL=min(旧,新) → RETURN
2. L1-D OR L2-1 OR (L0基础条件成立但未命中第1条的三组子条件) → 清空PSL, PSL-T=None → RETURN
3. L1-C → 设置PSL, PSL-T='empty', PSL=max(旧,新) → RETURN
4. ELSE → 设置PSL, PSL-T='empty', PSL=max(旧,新) → RETURN

设置PSL后不检测触线，直接返回
```

### 半仓14:55兜底逻辑总结（POS = 0.5）

```
检测点：14:55兜底操作
命中策略：First（自上而下，命中即停止）
1. L1-A OR (L0 WHEN (R-H >= T-1-H AND R-P > R-O AND R-DIF >= T-1-DIF AND R-MACD >= T-1-MACD AND (R-P - T-1-C)/T-1-C <0.19)) → 回补半仓, POS: 0.5 → 1.0 → RETURN
2. L1-D OR L2-1 → 不执行任何操作 → RETURN
3. L1-F → 卖出剩余半仓 → POS: 0.5 → 0 → RETURN
4. ELSE → 卖出剩余半仓 → POS: 0.5 → 0 → RETURN
```

当一只股票的POS值从1变到0.5以后，当天股票就进入不可触发条件的状态（比如，当天POS从1到0.5，当日就不会再触发条件变回1或者变回0），以下3个条件除外：
1. 14:55时触发L1-A条件，股票在POS从1变到0.5的当日即可在尾盘回补半仓，POS： 0.5 → 1.0；
2. 盘中整点触发L1-C条件，股票在POS从1变到0.5的当日即可卖出剩余半仓，POS： 0.5 → 0；
3. 14:55触发L1-F条件，股票在POS从1变到0.5的当日，POS： 0.5 → 0；

以上三个条件仅仅是把当日不能连续卖出和不能连续卖出又回补的要求给出了三种例外情况。
整点部分的卖出逻辑永远是整点时刻做触发判断，然后设置PSL，其余时间触发PSL，永远不可能存在在整点时刻设置了PSL的同时立即卖出的情况；
---

### 半仓实时检测（非整点）

```
IF (PSL已设置):
    IF (R-P <= PSL):
        → 卖剩余半仓
        → POS: 0.5 → 0

IF (PBL已设置):
    IF (R-P >= PBL):
        → 回补半仓
        → POS: 0.5 → 1.0
        → DAYS = 3
        → REBUY-DATE = T-0
```

---

### 回补半仓后初始化

```
回补成功后：
    → POS = 1.0
    → DAYS = 3（立即可卖+适用F2-B）
    → REBUY-DATE = T-0
	→ 记录 XH-233（回补时的H-233）
    → 记录 X-H（回补当天盘后最高价）
    → 记录这一次半仓买卖的正负值 = (半仓卖出价格-半仓买入价格)/半仓买入价格/2；最后把这个数据加入最终的盈亏数中
    → 其他变量保持不变
    → 清除PBL
```

---

## 卖出后去向判断（POS=0）

### 执行时机与数据
```
执行时机：after_trading（盘后）
使用数据：
- T-0-L、T-0-H：当天最低价、最高价（盘后确定）
- MA-10：盘后10日均线（用收盘价计算）
```

### 去向决策

```
IF (DC <= 2):
    
    IF (T-0-L > MA-10):
        → 去预备仓，DC保留
    
    ELSE IF (T-0-L <= MA-10 <= T-0-H):
        → 去准备仓，DC保留
    
    ELSE IF (T-0-H < MA-10):
        → 彻底离场，清除所有追踪数据

ELSE IF (DC > 2):
    → 彻底离场，清除所有追踪数据
```

---

## 第四部分：交易统计与显示

### 盈亏计算方式

```
整轮收益用统一记账法：把每次买入/回补当作“投入金额”，把每次卖出当作“按当时加权成本结算的已实现盈亏”，当股票最终 POS=0 时，收益率 =（累计已实现盈亏 / 累计投入金额）×100%。
这样天然覆盖：满仓一次进出、分两次半仓卖出、半仓卖出后回补、以及多次半仓波段。
```

### 统计指标

```
1. 总胜率 = 盈利次数 / 交易总数 × 100%

2. 超9%胜率 = 盈利>9%次数 / 交易总数 × 100%

3. 分DC胜率
   - DC=0和1时胜率）
   - DC=2时胜率）
```

---

## 第五部分：每日更新逻辑

### 盘前重置（before_trading）

```
清空当日变量：
    → PSL、PSL-T、PBL
    → TRG-TIME、买入线
    → F1/F2/H1/H2触发标记

保留跨日变量：
    → DC、T-1-H、T-1-DIF
    → POS、DAYS、B-P
    → XH-233、X-H
    → T-1-H、T-1-DIF、T-1-MACD
    → REBUY-DATE
```

### 盘后更新（after_trading）

```
1. 更新所有股票DC（预备仓、准备仓、买入仓）
2. 更新买入仓数据（DAYS+1等）
3. 准备仓出仓检查（DC>=3）
4. 记录准备仓昨日DIF
5. 执行选股入预备仓
6. 显示统计信息
```

---

## 第六部分：特殊规则总结

### 时间规则
```
1. T+1规则（首次买入）: DAYS < 2 不能卖出
2. T+1规则（回补买入）: 回补当天最多卖0.5
3. 10分钟观察期: DIF触发后10分钟设置买入线
4. 整点设置，非整点检测
5. 14:55兜底执行
```

### 价格线规则
```
1. 买入线 = R-H × 1.004
2. PSL = I-L[30min] × 0.996（可智能修正）
3. PBL = I-H[30min] × 1.004
4. PSL只涨不跌：max(旧,新)
5. PBL只跌不涨：min(旧,新)
6. PSL-T每次刷新
```

### 触发优先级
```
1. 系统优先级：1级 > 2级
2. 行为激进度优先（同级内）：
   - F1-C优先级最高（全仓卖出）
   - H1-C优先级最高（允许连续卖出）
```

### DC特殊规则
```
1. 创233日新高时DC重置为0
2. DC累加：+1
3. DC在仓位间转移时全程继承
4. DC>=2触发出局
```

### 20260208补丁备注：阶段5卖出链路无歧义说明（用于实现对齐）

1.整点铁律
除 14:55 兜底外，所有整点检测（10:00/10:30/11:00/11:30/13:30/14:00/14:30）只允许“设线/清线/授权”，禁止在同一根bar内直接成交（禁止触线成交）。触线成交只能发生在非整点时刻。

2.半仓锁（POS 从 1.0→0.5 当日）与三种例外
当日发生 POS: 1.0→0.5 后，股票进入“半仓锁当日不可操作”状态：默认当日不能再触发 0.5→1.0 或 0.5→0。仅允许以下三种例外：

14:55 命中 L1-A：允许当日回补半仓（0.5→1.0）

盘中整点命中 L1-C：仅授予“当日可触线卖剩余半仓”的资格（整点不卖；后续非整点触线才执行 0.5→0）

14:55 命中 L1-F：允许当日卖出剩余半仓（0.5→0）

说明：为避免混淆，上述三种例外在“总结行为”中被显式列出，不再隐含在 ELSE 里，便于日志回溯。

3.ELSE 的语义
ELSE 表示“除以上命中条件之外”，不代表某个固定条件。不同检测点的 ELSE 行为以该检测点的总结条款为准。

4. 由于14:30分设置的PSL可能会在14:55分和14:55应该运行的兜底逻辑冲突，所以现在禁止了14:55之后所有盘中的操作以避免这个问题。